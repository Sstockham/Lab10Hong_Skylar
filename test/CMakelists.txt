add_executable(mytest test.c unity_config.c ${CMAKE_SOURCE_DIR}/../src/lib.c)

target_link_libraries(mytest PRIVATE
    pico_stdlib
    unity)

target_include_directories(mytest PRIVATE ${CMAKE_SOURCE_DIR}/../include)
target_include_directories(mytest PRIVATE ${CMAKE_SOURCE_DIR})

pico_set_binary_type(mytest no_flash)

find_program(RENODE renode)

set(RENODE_FLAGS
  --disable-xwt
  --port -2
  --pid-file renode.pid
  --console
  )

add_test(NAME runmytest COMMAND
    ${RENODE}
     ${RENODE_FLAGS}
    -e "$elf=@$<TARGET_FILE:mytest>; $cwd=@${CMAKE_SOURCE_DIR}; include @${CMAKE_SOURCE_DIR}/test.resc"
    )
